<page-header
	class="block mb-4"
	title="Source catalog"
	linkToWiki="https://wiki.go.akamai-access.com/display/BI/Source+catalog">

	<ng-template #pageHeaderSubTitle>
		This page shows the list of all source apps and event types of the data that were ever sent to Galaxy,
		and review corresponding files on S3 buckets. It also shows the date when configs were applied and who applied them.
		It also allows to enabled/disabled the internal recon.
	</ng-template>
</page-header>

<form
	class="audit-form pb-3"
	ngNativeValidate
	class="d-flex flex-column flex-xxxl-row mb-2"
	(submit)="fetch()">

	<div class="d-flex flex-column flex-xl-row">
		<label class="text-nowrap text-xxl-right bold p-2 pt-xl-3">
			Filter by:
		</label>

		<div class="row align-items-center no-gutters">
			<div class="p-2">
				<div class="form-group m-0">
					<dropdown-item-picker
						e2e="bucket-list-dropdown"
						#sourceApps
						class="block w-100"
						placeholder="All Sources"
						[fixedWidth]="true"
						[dataObservable]="sourceAppListSubj"
						(paramsChanged)="changeSourceApp($event[0])">
					</dropdown-item-picker>
				</div>
			</div>

			<button
				type="submit"
				class="btn btn-default border-none pt-1 pb-1 ml-2"
				title="Refresh"
				[disabled]="loading">

				<i
					e2e="refresh"
					class="fa fa-refresh"
					[class.fa-spin]="loading">
				</i>
			</button>
		</div>
	</div>
</form>

<div class="table-responsive relative pt-3 pb-3">
	<div *ngIf="loading">
		<div
			e2e="loading-shade"
			class="bhn-loading-shade">
			<i
				e2e="loader"
				class="fa fa-pulse fa-spinner fa-2x"></i>
		</div>
	</div>

	<table
		e2e="source-catalog-table"
		class="table table-lg table-hover table-striped table-bordered m-0">

		<thead>
			<tr>
				<th class="align-middle">
					<div class="d-flex align-items-center">
						Source app

						<column-sort-v2
							[sortBy]="sortColumns.SOURCE_APP"
							[sortableItems]="sortableItems"
							[sortByObservable]="sortSubj"
							(changed)="changedSortBy($event)">
						</column-sort-v2>
					</div>
				</th>
				<th class="align-middle">
					<div class="d-flex align-items-center">
						Event type

						<column-sort-v2
							[sortBy]="sortColumns.EVENT_ID"
							[sortableItems]="sortableItems"
							[sortByObservable]="sortSubj"
							(changed)="changedSortBy($event)">
						</column-sort-v2>
					</div>
				</th>
				<th class="text-center align-middle">
					<div class="d-flex align-items-center justify-content-center">
						Config applied date

						<column-sort-v2
							[sortBy]="sortColumns.APPLIED_DATE"
							[sortableItems]="sortableItems"
							[sortByObservable]="sortSubj"
							(changed)="changedSortBy($event)">
						</column-sort-v2>
					</div>
				</th>
				<th class="text-center align-middle">Last updated user</th>
				<th class="text-center align-middle">Recon ON/OFF</th>
				<th></th>
			</tr>
		</thead>
		<tbody>
			<tr
				e2e="source-catalog-row"
				*ngFor="let item of items">

				<td
					e2e="source-app"
					class="align-middle">

					{{item.sourceApplication}}
				</td>

				<td
					e2e="event-id"
					class="align-middle">
					{{item.eventId}}
				</td>

				<td
					e2e="datamart-last-updated-date"
					class="text-center align-middle">

					{{item.appliedDate}}
				</td>

				<td
					e2e="last-updated-date-user"
					class="text-center align-middle">

					{{item.appliedUser}}
				</td>

				<td class="align-middle text-center fixed-width">
					<switch-control
						*permissions="{ container: containers.SOURCE_CATALOG, permissions: [permission.UPDATE] }"
						[active]="item.isReconActive"
						[disabled]="item.disabled"
						[loading]="item.loading"
						(changed)="switchConfigState($event, item)">
					</switch-control>
				</td>

				<td class="d-flex justify-content-around flex-column flex-xl-row align-items-center">
					<div class="text-center text-xl-right mr-2">
						<a
							[routerLink]="['/portal/config-storage']"
							[queryParams]="{
								'sourceApplication': item.sourceApplication,
								'eventId': item.eventId
							}">

							Configurations
						</a>
					</div>

					<div class="text-center text-xl-right">
						<a
							target="_blank"
							[routerLink]="[item.inputFilesPageUrl]"
							[queryParams]="{
								'sourceApplication': item.sourceApplication,
								'eventId': item.eventId
							}">

							Input files...
						</a>
					</div>

					<div class="align-items-center align-items-xl-left">
						<div
							e2e="navigations"
							class="btn-group"
							dropdown
							container="body"
							placement="right">

							<button
								class="btn btn-link dropdown-toggle"
								type="button"
								dropdownToggle
								role="menu"
								aria-controls="dropdown-container">

								S3 buckets
							</button>

							<ul
								e2e="actions-dropdown"
								class="dropdown-menu dropdown-menu-right dropdown-alignment"
								*dropdownMenu>

								<li
									*ngIf="item.isBatch"
									role="menuitem">

									<a
										[href]="composeS3Url(bucketType.BATCH, item)"
										target="_blank"
										class="dropdown-item pr-3 pl-3">

										<i
											class="fa fa-share-square-o mr-1 text-secondary"
											aria-hidden="true">
										</i>

										Batch bucket
									</a>
								</li>

								<li
									*ngIf="item.isBatch"
									role="menuitem" >

									<a
										[href]="composeS3Url(bucketType.HISTORICAL_BATCH, item)"
										target="_blank"
										class="dropdown-item pr-3 pl-3 d-none">

										<i
											class="fa fa-share-square-o mr-1 text-secondary"
											aria-hidden="true">
										</i>

										Historical Batch bucket
									</a>
								</li>

								<li role="menuitem">
									<a
										[href]="composeS3Url(bucketType.HISTORICAL_STAGE, item)"
										target="_blank"
										class="dropdown-item pr-3 pl-3 d-none">

										<i
											class="fa fa-share-square-o mr-1 text-secondary"
											aria-hidden="true">
										</i>

										Historical Stage Bucket
									</a>
								</li>

								<li role="menuitem">
									<a
										[href]="composeS3Url(bucketType.STAGE, item)"
										target="_blank"
										class="dropdown-item pr-3 pl-3">

										<i
											class="fa fa-share-square-o mr-1 text-secondary"
											aria-hidden="true">
										</i>

										Stage Bucket
									</a>
								</li>

								<li role="menuitem">
									<a
										[href]="composeS3Url(bucketType.INTERMEDIATE, item)"
										target="_blank"
										class="dropdown-item pr-3 pl-3">

										<i
											class="fa fa-share-square-o mr-1 text-secondary"
											aria-hidden="true">
										</i>

										Intermediate Bucket
									</a>
								</li>

								<li role="menuitem">
									<a
										[href]="composeS3Url(bucketType.FLATTENED, item)"
										target="_blank"
										class="dropdown-item pr-3 pl-3">

										<i
											class="fa fa-share-square-o mr-1 text-secondary"
											aria-hidden="true">
										</i>

										Flattened Bucket
									</a>
								</li>
							</ul>
						</div>
					</div>
				</td>
			</tr>

			<tr *ngIf="!items.length && !loading">
				<td
					e2e="no-data"
					colspan="6">

					No data.
				</td>
			</tr>
		</tbody>
	</table>
</div>

<div
	*ngIf="items && items.length"
	class="row">

	<div class="col-12">
		<paginator-v2
			[loading]="loading"
			[itemsPerPageEnabled]="true"
			[boundaryLinks]="true"
			(changed)="pageChanged()">
		</paginator-v2>
	</div>
</div>
